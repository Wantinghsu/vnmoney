<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‡»ğŸ‡³ è¶Šå—è¨˜å¸³</title>
    <style>
        /* V33 æ¨£å¼ï¼šä¿æŒ V32 ç©©å®šæ¶æ§‹ */
        body { background-color: #f0f0f0; font-family: sans-serif; margin: 0; padding: 10px; }
        * { box-sizing: border-box; }
        
        h3 { border-bottom: 2px solid #333; padding-bottom: 5px; margin-top: 20px; color: #000; }
        .input-group { background: #fff; padding: 15px; border: 2px solid #000; margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #000; font-size: 16px; }
        
        input, select, button {
            width: 100%; height: 45px; font-size: 16px; margin-bottom: 15px;
            border: 1px solid #000; border-radius: 0; background-color: #fff; color: #000;
            display: block; -webkit-appearance: none;
        }
        input[type="date"] { line-height: 45px; }
        
        button { background-color: #ddd; font-weight: bold; cursor: pointer; border-width: 2px; }
        button:active { background-color: #bbb; }
        #addBtn { background-color: #000; color: #fff; }
        
        table { width: 100%; border-collapse: collapse; background: #fff; border: 2px solid #000; }
        th, td { border: 1px solid #000; padding: 10px; text-align: left; color: #000; }
        th { background-color: #eee; }
        
        #summary { background: #fff; border: 2px solid #000; padding: 10px; line-height: 1.8; font-size: 16px; color: #000; }
        
        /* ç‹€æ…‹åˆ— */
        #statusMsg { 
            color: red; font-weight: bold; text-align: center; 
            padding: 10px; border: 2px dashed red; margin-bottom: 10px; 
            background: #fff; display: none; 
        }
    </style>
</head>
<body onload="init()">

    <h2 style="text-align:center;">ğŸ‡»ğŸ‡³ è¶Šå—è¨˜å¸³ V1</h2>

    <div id="statusMsg">ç³»çµ±æº–å‚™å°±ç·’</div>

    <div style="margin-bottom: 10px; text-align:right;">
        <input type="file" id="fileIn" onchange="importData(this)" style="display:none">
        <button onclick="document.getElementById('fileIn').click()" style="width:auto; display:inline-block; padding:0 10px;">åŒ¯å…¥èˆŠæª”</button>
        <button onclick="exportDataSmart()" style="width:auto; display:inline-block; padding:0 10px; background:#e0e0e0;">ğŸ“¤ åŒ¯å‡ºå‚™ä»½</button>
    </div>

    <div class="input-group">
        <input type="hidden" id="editId">
        <label>1. æ—¥æœŸ</label> <input type="date" id="dateIn">
        <label>2. ä»˜æ¬¾äºº</label> 
        <select id="memberIn">
            <option value="æ¦®">æ¦®</option>
            <option value="å¦‚">å¦‚</option>
            <option value="ç¿”">ç¿”</option>
            <option value="åº­">åº­</option>
            <option value="ä¸­">ä¸­</option>
        </select>
        <label>3. å“é …</label> <input type="text" id="itemIn" placeholder="è¼¸å…¥é …ç›®...">
        
        <label>4. é‡‘é¡</label> 
        <input type="number" id="amountIn" placeholder="0" inputmode="decimal">
        
        <label>5. å¹£åˆ¥</label> 
        <select id="currencyIn">
            <option value="VND">VND (è¶Šå—ç›¾)</option>
            <option value="TWD">TWD (å°å¹£)</option>
        </select>

        <button id="addBtn" onclick="saveData()">ï¼‹ ç¢ºèªå„²å­˜</button>
        <button id="cancelBtn" onclick="resetForm()" style="display:none; color:red; border-color:red; background:#fff;">å–æ¶ˆä¿®æ”¹</button>
    </div>

    <h3>ğŸ“Š çµ±è¨ˆçµæœ (åŒ¯ç‡TWD:VND = 1:835.63)</h3>
    <div id="summary">è¨ˆç®—ä¸­...</div>

    <h3>ğŸ“ æ˜ç´°åˆ—è¡¨</h3>
    <table id="listTable">
        <thead>
            <tr>
                <th>å…§å®¹</th>
                <th width="80">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div style="margin-top: 30px; text-align: center;">
        <button id="resetBtn" onclick="hardResetClick()" style="background:#fff; color:red; border:1px dashed red;">âš ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
    </div>

<script>
    // è³‡æ–™åº« Key
    var KEY = 'vietnam_trip_v1_final';
    // åŒ¯ç‡
    var RATE = 835.63;
    var list = [];
    var resetClickCount = 0;

    function showMsg(text) {
        var el = document.getElementById('statusMsg');
        el.innerText = text;
        el.style.display = 'block';
        setTimeout(function(){ el.style.display = 'none'; }, 3000);
    }

    function init() {
        document.getElementById('dateIn').valueAsDate = new Date();
        var str = localStorage.getItem(KEY);
        if(str) {
            try { list = JSON.parse(str); } catch(e){ list = []; }
        }
        render();
    }

    window.del = function(id) {
        var newList = [];
        for(var i=0; i<list.length; i++) {
            if(String(list[i].id) !== String(id)) newList.push(list[i]);
        }
        list = newList;
        saveToLocal();
        showMsg("ğŸ—‘ï¸ è³‡æ–™å·²åˆªé™¤");
    };

    window.edit = function(id) {
        var t = null;
        for(var i=0; i<list.length; i++) {
            if(String(list[i].id) === String(id)) t = list[i];
        }
        if(!t) return;

        document.getElementById('editId').value = t.id;
        document.getElementById('dateIn').value = t.date;
        document.getElementById('memberIn').value = t.member;
        document.getElementById('itemIn').value = t.item;
        document.getElementById('amountIn').value = t.amount;
        document.getElementById('currencyIn').value = t.currency;

        document.getElementById('addBtn').innerText = "ğŸ’¾ å„²å­˜ä¿®æ”¹";
        document.getElementById('cancelBtn').style.display = "block";
        window.scrollTo(0,0);
        showMsg("âœï¸ é€²å…¥ç·¨è¼¯æ¨¡å¼");
    };

    function saveData() {
        var id = document.getElementById('editId').value;
        var d = document.getElementById('dateIn').value;
        var m = document.getElementById('memberIn').value;
        var i = document.getElementById('itemIn').value;
        var a = document.getElementById('amountIn').value;
        var c = document.getElementById('currencyIn').value;

        if(!a) { showMsg("âŒ é‡‘é¡å¿…å¡«ï¼"); return; }
        if(!i) i = "(æœªå¡«)";

        var numA = parseFloat(a);
        if(isNaN(numA)) numA = 0;

        var obj = {
            "id": id ? String(id) : ('ID' + new Date().getTime()),
            "date": d,
            "member": m,
            "item": i,
            "amount": numA,
            "currency": c
        };

        if(id) {
            var idx = -1;
            for(var k=0; k<list.length; k++) {
                if(String(list[k].id) === String(id)) idx = k;
            }
            if(idx !== -1) list[idx] = obj;
            else list.push(obj);
        } else {
            list.push(obj);
        }

        resetForm();
        saveToLocal();
        showMsg("âœ… å„²å­˜æˆåŠŸï¼");
    }

    function saveToLocal() {
        localStorage.setItem(KEY, JSON.stringify(list));
        render();
    }

    function render() {
        var tbody = document.querySelector('#listTable tbody');
        var summary = document.getElementById('summary');
        
        tbody.innerHTML = "";
        list.sort(function(a,b){ return a.date < b.date ? 1 : -1 });

        var totalTWD = 0;
        var map = {};
        var names = ["æ¦®", "å¦‚", "ç¿”", "åº­", "ä¸­"];
        for(var n=0; n<names.length; n++) map[names[n]] = 0;

        var tableHtml = "";
        for(var k=0; k<list.length; k++) {
            var row = list[k];
            var amt = parseFloat(row.amount) || 0;
            var val = (row.currency == 'VND') ? (amt / RATE) : amt;
            
            totalTWD += val;
            if(map[row.member] === undefined) map[row.member] = 0;
            map[row.member] += val;

            var convertText = "";
            if (row.currency === 'TWD') {
                var vndVal = Math.round(amt * RATE);
                convertText = " ( = " + vndVal.toLocaleString() + " VND)";
            } else {
                var twdVal = Math.round(amt / RATE);
                convertText = " ( = " + twdVal.toLocaleString() + " TWD)";
            }

            tableHtml += "<tr>";
            tableHtml += "<td><b>" + row.date + "</b><br>[" + row.member + "] " + row.item + "<br>";
            tableHtml += "<span style='color:blue'>" + amt.toLocaleString() + " " + row.currency + "</span>";
            tableHtml += "<span style='color:black; font-weight:normal;'>" + convertText + "</span>"; 
            tableHtml += "</td>";
            
            tableHtml += "<td>";
            tableHtml += "<button onclick=\"window.edit('" + row.id + "')\" style='margin-bottom:5px;'>æ”¹</button>";
            tableHtml += "<button onclick=\"window.del('" + row.id + "')\" style='background:#fff; color:red; border-color:red;'>åˆª</button>";
            tableHtml += "</td>";
            tableHtml += "</tr>";
        }
        tbody.innerHTML = tableHtml;

        var htmlStats = "";
        for(var name in map) {
            var rawTWD = map[name];
            var displayTWD = Math.round(rawTWD);
            var displayVND = Math.round(rawTWD * RATE);
            htmlStats += "<b>" + name + "</b>: " + displayTWD.toLocaleString() + " å°å¹£ (" + displayVND.toLocaleString() + " è¶Šç›¾)<br>";
        }
        var grandVND = Math.round(totalTWD * RATE);
        htmlStats += "<hr style='border:1px solid #000'>";
        htmlStats += "<div style='text-align:center; font-size:18px;'><b>ç¸½è¨ˆ: " + Math.round(totalTWD).toLocaleString() + " TWD</b><br>";
        htmlStats += "<small>(" + grandVND.toLocaleString() + " VND)</small></div>";

        summary.innerHTML = htmlStats;
    }

    function resetForm() {
        document.getElementById('editId').value = "";
        document.getElementById('itemIn').value = "";
        document.getElementById('amountIn').value = "";
        document.getElementById('addBtn').innerText = "ï¼‹ ç¢ºèªå„²å­˜";
        document.getElementById('cancelBtn').style.display = "none";
    }

    function hardResetClick() {
        var btn = document.getElementById('resetBtn');
        if(resetClickCount === 0) {
            btn.innerText = "ğŸ›‘ å†æŒ‰ä¸€æ¬¡ç¢ºå®šåˆªé™¤ï¼";
            btn.style.backgroundColor = "red";
            btn.style.color = "white";
            resetClickCount = 1;
            setTimeout(function(){
                resetClickCount = 0;
                btn.innerText = "âš ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™";
                btn.style.backgroundColor = "#fff";
                btn.style.color = "red";
            }, 3000);
        } else {
            localStorage.removeItem(KEY);
            list = [];
            render();
            showMsg("ğŸ’¥ è³‡æ–™å·²å…¨éƒ¨æ¸…ç©º");
            resetClickCount = 0;
            btn.innerText = "âš ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™";
            btn.style.backgroundColor = "#fff";
            btn.style.color = "red";
        }
    }

    // --- V33 ä¿®æ”¹ï¼šä½¿ç”¨ octet-stream æ¬ºé¨™ç€è¦½å™¨ï¼Œå¼·åˆ¶å–®æª”ä¸‹è¼‰ ---
    async function exportDataSmart() {
        if(list.length === 0) { showMsg("æ²’è³‡æ–™å¯åŒ¯å‡º"); return; }
        
        var jsonStr = JSON.stringify(list);
        
        var now = new Date();
        var YYYY = now.getFullYear();
        var MM = String(now.getMonth() + 1).padStart(2, '0');
        var DD = String(now.getDate()).padStart(2, '0');
        var HH = String(now.getHours()).padStart(2, '0');
        var mm = String(now.getMinutes()).padStart(2, '0');
        var ss = String(now.getSeconds()).padStart(2, '0');
        
        var fileName = "è¶Šå—è¨˜å¸³_" + YYYY + MM + DD + "_" + HH + mm + "_" + ss + ".json";

        // V33: æ”¾æ£„ navigator.shareï¼Œå› ç‚º iOS ç¸½æ„›ç”¢ç”Ÿå¤šé¤˜çš„æ–‡å­—æª”
        // æ”¹ç”¨å¼·åˆ¶äºŒé€²ä½ä¸‹è¼‰ (application/octet-stream)
        // é€™æ¨£ç€è¦½å™¨å°±ä¸æœƒå˜—è©¦ã€Œé–‹å•Ÿã€å®ƒï¼Œè€Œæ˜¯æœƒå½ˆå‡ºã€Œä¸‹è¼‰ã€è¦–çª—
        
        var blob = new Blob([jsonStr], {type: "application/octet-stream"});
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        showMsg("å·²è§¸ç™¼ä¸‹è¼‰ (è«‹åœ¨å½ˆå‡ºè¦–çª—é»é¸ä¸‹è¼‰)");
    }

    function importData(input) {
        var f = input.files[0];
        if(!f) return;
        var r = new FileReader();
        r.onload = function(e) {
            try {
                var arr = JSON.parse(e.target.result);
                if(Array.isArray(arr)) {
                    var count = 0;
                    var currentIds = [];
                    for(var k=0; k<list.length; k++) {
                        currentIds.push(String(list[k].id));
                    }

                    for(var i=0; i<arr.length; i++) {
                        var newItem = arr[i];
                        if(currentIds.indexOf(String(newItem.id)) === -1) {
                            list.push(newItem);
                            count++;
                        }
                    }
                    
                    saveToLocal();
                    if(count > 0) {
                        showMsg("åŒ¯å…¥æˆåŠŸï¼æ–°å¢äº† " + count + " ç­†è³‡æ–™");
                    } else {
                        showMsg("åŒ¯å…¥å®Œæˆï¼Œä½†æ‰€æœ‰è³‡æ–™å·²å­˜åœ¨ (ç„¡æ–°å¢)");
                    }
                }
            } catch(err){ showMsg("æª”æ¡ˆéŒ¯èª¤"); }
            input.value = "";
        };
        r.readAsText(f);
    }
</script>
</body>
</html>
