<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‡»ğŸ‡³ è¶Šå—è¨˜å¸³</title>
    <style>
        /* V45 æ¨£å¼ */
        body { 
            background-color: #f0f0f0; 
            font-family: sans-serif; 
            margin: 0; 
            padding: 5px; 
            touch-action: manipulation; 
        }
        * { box-sizing: border-box; }
        
        h3 { border-bottom: 2px solid #333; padding-bottom: 5px; margin-top: 15px; color: #000; font-size: 18px;}
        
        .input-group { background: #fff; padding: 10px; border: 2px solid #000; margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 3px; color: #000; font-size: 14px; }
        
        input, select, button {
            width: 100%; height: 40px; font-size: 16px; margin-bottom: 10px;
            border: 1px solid #000; border-radius: 0; background-color: #fff; color: #000;
            display: block; -webkit-appearance: none;
            touch-action: manipulation;
        }
        input[type="date"] { line-height: 40px; }
        
        button { background-color: #ddd; font-weight: bold; cursor: pointer; border-width: 1px; }
        button:active { background-color: #bbb; }
        #addBtn { background-color: #000; color: #fff; border: 1px solid #000; }
        
        /* V45 æ–°å¢ï¼šåˆ†é æŒ‰éˆ•å€å¡Š */
        .tabs-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 5px;
        }
        .tab-btn {
            flex: 1; /* å¹³å‡åˆ†é…å¯¬åº¦ */
            height: 35px;
            line-height: 33px;
            font-size: 14px;
            padding: 0;
            border: 1px solid #999;
            background-color: #fff;
            color: #333;
            min-width: 40px;
        }
        /* é¸ä¸­ç‹€æ…‹ */
        .tab-btn.active {
            background-color: #000 !important;
            color: #fff !important;
            border-color: #000;
        }

        #listTable { 
            width: 100%; 
            border-collapse: collapse; 
            background: #fff; 
            border: 1px solid #000; 
            font-size: 14px; 
            table-layout: fixed; 
        }
        
        #listTable thead th {
            background-color: #eee;
            border-bottom: 1px solid #000;
            padding: 8px 4px;
            font-size: 13px;
            text-align: center;
        }

        .col-date { width: 15%; text-align: center; color: #666; font-size: 12px; font-weight: bold; vertical-align: top; padding-top: 12px; }
        .col-detail { width: 60%; padding: 8px 4px; vertical-align: middle; }
        .col-op { width: 25%; text-align: center; vertical-align: middle; padding: 0 2px; }

        #listTable td { border-bottom: 1px solid #ddd; }

        .detail-line1 { font-size: 15px; font-weight: bold; color: #000; margin-bottom: 2px; }
        .detail-line2 { font-size: 13px; }
        .money-main { color: blue; font-weight: bold; }
        .money-sub { color: #666; font-size: 11px; }

        .btn-small {
            width: auto; height: 32px; line-height: 30px;
            font-size: 14px; padding: 0 8px; margin: 0 2px;
            border: 1px solid #999; 
            background: #eee;
            display: inline-block; color: #000;
            touch-action: manipulation;
        }
        
        .btn-del { 
            background-color: #fff; 
            border: 1px solid red; 
            color: red; 
            transition: all 0.2s; 
        }
        
        #summary { background: #fff; border: 2px solid #000; padding: 10px; font-size: 14px; color: #000; }
        .stats-table { width: 100%; border-collapse: collapse; }
        .stats-table td { border: none; padding: 4px 0; vertical-align: bottom; }
        .st-name { text-align: left; width: 15%; font-weight: bold; white-space: nowrap; }
        .st-twd { text-align: right; width: 35%; font-weight: bold; }
        .st-vnd { text-align: right; width: 50%; color: #666; font-size: 13px; }

        #statusMsg { 
            color: red; font-weight: bold; text-align: center; 
            padding: 5px; border: 1px dashed red; margin-bottom: 10px; 
            background: #fff; display: none; font-size: 14px;
        }
        
        #realtimeText {
            color: blue; font-weight: bold; font-size: 14px; margin-top: -8px; margin-bottom: 10px; display: block; min-height: 18px;
        }
    </style>
</head>
<body onload="init()">

    <h2 style="text-align:center; margin:10px 0;">ğŸ‡»ğŸ‡³ è¶Šå—è¨˜å¸³</h2>

    <div id="statusMsg">ç³»çµ±æº–å‚™å°±ç·’</div>

    <div style="margin-bottom: 10px; text-align:right;">
        <input type="file" id="fileIn" onchange="importData(this)" style="display:none">
        <button onclick="document.getElementById('fileIn').click()" style="width:auto; display:inline-block; padding:0 10px; height:35px; line-height:35px;">åŒ¯å…¥</button>
        <button onclick="exportDataSmart()" style="width:auto; display:inline-block; padding:0 10px; height:35px; line-height:35px; background:#e0e0e0;">å‚™ä»½</button>
    </div>

    <div class="input-group">
        <input type="hidden" id="editId">
        <label>1. æ—¥æœŸ</label> <input type="date" id="dateIn">
        <label>2. ä»˜æ¬¾äºº</label> 
        <select id="memberIn">
            <option value="æ¦®">æ¦®</option>
            <option value="å¦‚">å¦‚</option>
            <option value="ç¿”">ç¿”</option>
            <option value="åº­">åº­</option>
            <option value="ä¸­">ä¸­</option>
        </select>
        <label>3. å“é …</label> <input type="text" id="itemIn" placeholder="è¼¸å…¥é …ç›®...">
        
        <label>4. å¹£åˆ¥</label> 
        <select id="currencyIn" onchange="updateRealtime()">
            <option value="VND">VND (è¶Šå—ç›¾)</option>
            <option value="TWD">TWD (å°å¹£)</option>
        </select>

        <label>5. é‡‘é¡</label> 
        <input type="text" id="amountIn" placeholder="0" inputmode="decimal" onkeyup="formatInputAndCalc(this)">
        <div id="realtimeText"></div>

        <button id="addBtn" onclick="saveData()">ï¼‹ å„²å­˜</button>
        <button id="cancelBtn" onclick="resetForm()" style="display:none; color:red; border-color:red; background:#fff;">å–æ¶ˆ</button>
    </div>

    <h3>ğŸ“Š çµ±è¨ˆçµæœ (TWD:VND=1:835.63)</h3>
    <div id="summary">è¨ˆç®—ä¸­...</div>

    <h3>ğŸ“ æ˜ç´°åˆ—è¡¨</h3>
    
    <div class="tabs-container">
        <button class="tab-btn active" onclick="setFilter('ALL')" id="tab-ALL">å…¨éƒ¨</button>
        <button class="tab-btn" onclick="setFilter('æ¦®')" id="tab-æ¦®">æ¦®</button>
        <button class="tab-btn" onclick="setFilter('å¦‚')" id="tab-å¦‚">å¦‚</button>
        <button class="tab-btn" onclick="setFilter('ç¿”')" id="tab-ç¿”">ç¿”</button>
        <button class="tab-btn" onclick="setFilter('åº­')" id="tab-åº­">åº­</button>
        <button class="tab-btn" onclick="setFilter('ä¸­')" id="tab-ä¸­">ä¸­</button>
    </div>

    <table id="listTable">
        <thead>
            <tr>
                <th class="col-date">æ—¥æœŸ</th>
                <th class="col-detail">å…§å®¹ / é‡‘é¡</th>
                <th class="col-op">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div style="margin-top: 30px; text-align: center;">
        <button id="resetBtn" onclick="hardResetClick()" style="background:#fff; color:red; border:1px dashed red; height:35px;">âš ï¸ æ¸…ç©ºè³‡æ–™</button>
    </div>

<script>
    var KEY = 'vietnam_trip_v1_final';
    var RATE = 835.63;
    var list = [];
    var deleteConfirmState = {}; 
    var resetClickCount = 0;
    
    // V45 æ–°å¢ï¼šç•¶å‰ç¯©é¸ç‹€æ…‹
    var currentFilter = 'ALL';

    function showMsg(text) {
        var el = document.getElementById('statusMsg');
        el.innerText = text;
        el.style.display = 'block';
        setTimeout(function(){ el.style.display = 'none'; }, 3000);
    }

    function init() {
        var today = new Date();
        var yyyy = today.getFullYear();
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var dd = String(today.getDate()).padStart(2, '0');
        var todayStr = yyyy + "-" + mm + "-" + dd;
        
        document.getElementById('dateIn').value = todayStr;

        var str = localStorage.getItem(KEY);
        if(str) {
            try { list = JSON.parse(str); } catch(e){ list = []; }
        }
        render();
        updateRealtime();
    }

    // V45 æ–°å¢ï¼šåˆ‡æ›ç¯©é¸åŠŸèƒ½
    function setFilter(name) {
        currentFilter = name;
        render(); // é‡æ–°æ¸²æŸ“è¡¨æ ¼
    }

    function formatInputAndCalc(input) {
        var rawValue = input.value.replace(/,/g, '');
        if (!rawValue) { updateRealtime(); return; }
        var num = parseFloat(rawValue);
        if (isNaN(num)) return;
        input.value = num.toLocaleString('en-US');
        updateRealtime();
    }

    function getRawAmount() {
        var val = document.getElementById('amountIn').value;
        if(!val) return 0;
        return parseFloat(val.replace(/,/g, ''));
    }

    function updateRealtime() {
        var amt = getRawAmount();
        var curr = document.getElementById('currencyIn').value;
        var display = document.getElementById('realtimeText');

        if (isNaN(amt) || amt === 0) {
            display.innerText = "";
            return;
        }

        if (curr === 'TWD') {
            var res = Math.round(amt * RATE);
            display.innerText = "= " + res.toLocaleString() + " VND";
        } else {
            var res = Math.round(amt / RATE);
            display.innerText = "= " + res.toLocaleString() + " TWD";
        }
    }

    window.del = function(id, btn) {
        if (!deleteConfirmState[id]) {
            deleteConfirmState[id] = true;
            if(btn) {
                btn.style.backgroundColor = "red";
                btn.style.color = "white";
                setTimeout(function() {
                    deleteConfirmState[id] = false;
                    if(btn) {
                        btn.style.backgroundColor = "#fff";
                        btn.style.color = "red";
                    }
                }, 3000);
            }
            return;
        }

        var newList = [];
        for(var i=0; i<list.length; i++) {
            if(String(list[i].id) !== String(id)) newList.push(list[i]);
        }
        list = newList;
        
        delete deleteConfirmState[id];
        saveToLocal();
        showMsg("ğŸ—‘ï¸ è³‡æ–™å·²åˆªé™¤");
    };

    window.edit = function(id) {
        var t = null;
        for(var i=0; i<list.length; i++) {
            if(String(list[i].id) === String(id)) t = list[i];
        }
        if(!t) return;

        document.getElementById('editId').value = t.id;
        document.getElementById('dateIn').value = t.date;
        document.getElementById('memberIn').value = t.member;
        document.getElementById('itemIn').value = t.item;
        document.getElementById('amountIn').value = parseFloat(t.amount).toLocaleString('en-US');
        document.getElementById('currencyIn').value = t.currency;

        document.getElementById('addBtn').innerText = "ğŸ’¾ å„²å­˜";
        document.getElementById('cancelBtn').style.display = "block";
        
        updateRealtime();
        window.scrollTo(0,0);
        showMsg("âœï¸ é€²å…¥ç·¨è¼¯æ¨¡å¼");
    };

    function saveData() {
        var id = document.getElementById('editId').value;
        var d = document.getElementById('dateIn').value;
        var m = document.getElementById('memberIn').value;
        var i = document.getElementById('itemIn').value;
        var numA = getRawAmount();
        var c = document.getElementById('currencyIn').value;

        if(numA === 0) { showMsg("âŒ é‡‘é¡å¿…å¡«ï¼"); return; }
        if(!i) i = "(æœªå¡«)";

        var obj = {
            "id": id ? String(id) : ('ID' + new Date().getTime()),
            "date": d,
            "member": m,
            "item": i,
            "amount": numA,
            "currency": c
        };

        if(id) {
            var idx = -1;
            for(var k=0; k<list.length; k++) {
                if(String(list[k].id) === String(id)) idx = k;
            }
            if(idx !== -1) list[idx] = obj;
            else list.push(obj);
        } else {
            list.push(obj);
        }

        resetForm();
        saveToLocal();
        showMsg("âœ… å„²å­˜æˆåŠŸï¼");
    }

    function saveToLocal() {
        localStorage.setItem(KEY, JSON.stringify(list));
        render();
    }

    function render() {
        deleteConfirmState = {};
        
        // --- V45: æ›´æ–°åˆ†é æŒ‰éˆ•ç‹€æ…‹ ---
        var allTabs = document.querySelectorAll('.tab-btn');
        allTabs.forEach(function(btn){ btn.classList.remove('active'); });
        var activeBtn = document.getElementById('tab-' + currentFilter);
        if(activeBtn) activeBtn.classList.add('active');

        var tbody = document.querySelector('#listTable tbody');
        var summary = document.getElementById('summary');
        
        tbody.innerHTML = "";
        // å…ˆæ’åº
        list.sort(function(a,b){ return a.date < b.date ? 1 : -1 });

        var totalTWD = 0;
        var map = {};
        var names = ["æ¦®", "å¦‚", "ç¿”", "åº­", "ä¸­"];
        for(var n=0; n<names.length; n++) map[names[n]] = 0;

        var tableHtml = "";
        for(var k=0; k<list.length; k++) {
            var row = list[k];
            var amt = parseFloat(row.amount) || 0;
            var val = (row.currency == 'VND') ? (amt / RATE) : amt;
            
            // çµ±è¨ˆæ°¸é è¨ˆç®—æ‰€æœ‰äººï¼Œä¸å—éæ¿¾å½±éŸ¿
            totalTWD += val;
            if(map[row.member] === undefined) map[row.member] = 0;
            map[row.member] += val;

            // --- V45: åˆ—è¡¨éæ¿¾é‚è¼¯ ---
            // å¦‚æœç¾åœ¨ä¸æ˜¯çœ‹å…¨éƒ¨ï¼Œä¸”é€™ç­†è³‡æ–™çš„ä»˜æ¬¾äººè·Ÿç¯©é¸çš„ä¸ä¸€æ¨£ï¼Œå°±è·³éä¸é¡¯ç¤º
            if (currentFilter !== 'ALL' && row.member !== currentFilter) {
                continue;
            }

            var convertText = "";
            if (row.currency === 'TWD') {
                var vndVal = Math.round(amt * RATE);
                convertText = " (=" + vndVal.toLocaleString() + " VND)";
            } else {
                var twdVal = Math.round(amt / RATE);
                convertText = " (=" + twdVal.toLocaleString() + " TWD)";
            }

            var shortDate = row.date.substring(5);

            tableHtml += "<tr>";
            tableHtml += "<td class='col-date'>" + shortDate + "</td>";
            tableHtml += "<td class='col-detail'>";
            tableHtml += "<div class='detail-line1'>[" + row.member + "] " + row.item + "</div>";
            tableHtml += "<div class='detail-line2'>";
            tableHtml += "<span class='money-main'>" + amt.toLocaleString() + " " + row.currency + "</span>";
            tableHtml += "<span class='money-sub'>" + convertText + "</span>";
            tableHtml += "</div>";
            tableHtml += "</td>";
            tableHtml += "<td class='col-op'>";
            tableHtml += "<button class='btn-small' onclick=\"window.edit('" + row.id + "')\">æ”¹</button>";
            tableHtml += "<button class='btn-small btn-del' onclick=\"window.del('" + row.id + "', this)\">åˆª</button>";
            tableHtml += "</td>";
            tableHtml += "</tr>";
        }
        tbody.innerHTML = tableHtml;

        // V45: å¦‚æœéæ¿¾å¾Œæ²’æœ‰è³‡æ–™
        if (tableHtml === "") {
            tbody.innerHTML = "<tr><td colspan='3' style='text-align:center; padding:20px; color:#999;'>æ­¤äººç„¡æ¶ˆè²»ç´€éŒ„</td></tr>";
        }

        var statsTable = "<table class='stats-table'>";
        for(var name in map) {
            var rawTWD = map[name];
            var displayTWD = Math.round(rawTWD);
            var displayVND = Math.round(rawTWD * RATE);
            
            statsTable += "<tr>";
            statsTable += "<td class='st-name'>" + name + ":</td>";
            statsTable += "<td class='st-twd'>" + displayTWD.toLocaleString() + " TWD</td>";
            statsTable += "<td class='st-vnd'>(" + displayVND.toLocaleString() + " VND)</td>";
            statsTable += "</tr>";
        }

        var grandVND = Math.round(totalTWD * RATE);
        
        statsTable += "<tr style='border-top: 1px solid #000;'>"; 
        statsTable += "<td class='st-name' style='padding-top:8px;'>ç¸½è¨ˆ:</td>";
        statsTable += "<td class='st-twd' style='padding-top:8px; color:blue; font-size:15px;'>" + Math.round(totalTWD).toLocaleString() + " TWD</td>";
        statsTable += "<td class='st-vnd' style='padding-top:8px;'>(" + grandVND.toLocaleString() + " VND)</td>";
        statsTable += "</tr>";
        
        statsTable += "</table>";

        summary.innerHTML = statsTable;
    }

    function resetForm() {
        document.getElementById('editId').value = "";
        document.getElementById('itemIn').value = "";
        document.getElementById('amountIn').value = "";
        document.getElementById('realtimeText').innerText = "";
        
        document.getElementById('addBtn').innerText = "ï¼‹ å„²å­˜";
        document.getElementById('cancelBtn').style.display = "none";
        
        var today = new Date();
        var yyyy = today.getFullYear();
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('dateIn').value = yyyy + "-" + mm + "-" + dd;
    }

    function hardResetClick() {
        var btn = document.getElementById('resetBtn');
        if(resetClickCount === 0) {
            btn.innerText = "ğŸ›‘ ç¢ºå®šæ¸…ç©ºï¼Ÿ";
            btn.style.backgroundColor = "red";
            btn.style.color = "white";
            resetClickCount = 1;
            setTimeout(function(){
                resetClickCount = 0;
                btn.innerText = "âš ï¸ æ¸…ç©ºè³‡æ–™";
                btn.style.backgroundColor = "#fff";
                btn.style.color = "red";
            }, 3000);
        } else {
            localStorage.removeItem(KEY);
            list = [];
            render();
            showMsg("ğŸ’¥ å·²æ¸…ç©º");
            resetClickCount = 0;
            btn.innerText = "âš ï¸ æ¸…ç©ºè³‡æ–™";
            btn.style.backgroundColor = "#fff";
            btn.style.color = "red";
        }
    }

    async function exportDataSmart() {
        if(list.length === 0) { showMsg("æ²’è³‡æ–™"); return; }
        var jsonStr = JSON.stringify(list);
        var now = new Date();
        var YYYY = now.getFullYear();
        var MM = String(now.getMonth() + 1).padStart(2, '0');
        var DD = String(now.getDate()).padStart(2, '0');
        var HH = String(now.getHours()).padStart(2, '0');
        var mm = String(now.getMinutes()).padStart(2, '0');
        var ss = String(now.getSeconds()).padStart(2, '0');
        var fileName = "è¶Šå—è¨˜å¸³_" + YYYY + MM + DD + "_" + HH + mm + "_" + ss + ".json";

        var isShareSupported = false;
        if (navigator.share && navigator.canShare) {
            var testFile = new File([jsonStr], fileName, { type: "application/json" });
            if (navigator.canShare({ files: [testFile] })) { isShareSupported = true; }
        }

        if (isShareSupported) {
            try {
                var file = new File([jsonStr], fileName, { type: "application/json" });
                await navigator.share({ files: [file] });
                showMsg("âœ… åŒ¯å‡ºæˆåŠŸï¼");
            } catch (err) {
                if (err.name === 'AbortError' || err.message.indexOf('Abort') !== -1) {
                    showMsg("å·²å–æ¶ˆåŒ¯å‡º");
                } else {
                    console.log(err); showMsg("åŒ¯å‡ºåŠŸèƒ½ç•°å¸¸");
                }
            }
            return;
        }

        var blob = new Blob([jsonStr], {type: "application/octet-stream"});
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showMsg("âœ… åŒ¯å‡ºæˆåŠŸ (å·²ä¸‹è¼‰)");
    }

    function importData(input) {
        var f = input.files[0];
        if(!f) return;
        var r = new FileReader();
        r.onload = function(e) {
            try {
                var arr = JSON.parse(e.target.result);
                if(Array.isArray(arr)) {
                    var count = 0;
                    var currentIds = [];
                    for(var k=0; k<list.length; k++) currentIds.push(String(list[k].id));
                    for(var i=0; i<arr.length; i++) {
                        var newItem = arr[i];
                        if(currentIds.indexOf(String(newItem.id)) === -1) {
                            list.push(newItem);
                            count++;
                        }
                    }
                    saveToLocal();
                    if(count > 0) showMsg("åŒ¯å…¥ " + count + " ç­†");
                    else showMsg("ç„¡æ–°è³‡æ–™");
                }
            } catch(err){ showMsg("æª”æ¡ˆéŒ¯èª¤"); }
            input.value = "";
        };
        r.readAsText(f);
    }
</script>
</body>
</html>
